---
title: Optimize generate report
description: solve issue about when one of the export button can not click but export metric button can click
---

# Context
Considering to fix the issue about when one of the export button can not click but export metric button can click, and change logic about polling api in backend. we have to optimize generate report flow.

# Design
## C2 - Generate report - AS-IS

### Sequence Diagram

```plantuml
@startuml report
skin rose
title C2 - Heartbeat - Generate Report - Transition
participant Frontend
participant Backend
participant Jira
participant Buildkite
participant Github

Frontend -> Backend: generate metrics for board related
activate Backend
Backend --> Frontend: response 202 with callback
deactivate Backend

group async process board related metrics
    Backend -> Jira: get Jira raw data
    activate Backend
    activate Jira
    Jira --> Backend: Jira raw 
    deactivate Jira
    Backend -> Backend: calculate metrics for velocity, cycle time and classification
    Backend -> Backend: generate board report csv
    deactivate Backend
    note left
        response.boardMetricsCompleted is true
        board metrics are ready for display
        board csv is ready for download
    end note
end

Frontend -> Backend: generate metrics for pipeline,Source control(if required) related
activate Backend
Backend --> Frontend: response 202 with callback
deactivate Backend

group async process pipeline and sourcecontrol related metrics
    Backend -> Buildkite: get Buildkite raw data
    activate Backend
    activate Buildkite
    Buildkite --> Backend: Buildkite raw data
    deactivate Buildkite
    Backend -> Backend: calculate metrics for deployment frequency, \nchange failure rate and mean time to recovery
    note left
        pipeline metrics are ready for display
    end note
    opt if lead time for change required
        Backend -> Github: get Github raw data
        activate  Github
        Github --> Backend: Github raw data
        deactivate Github
        Backend -> Backend: calculate metrics for lead time for change
        note left
            LTFC is ready for display
        end note
    end
    Backend -> Backend: generate pipeline report csv with github data if required
    note left
        response.doraMetricsCompleted is true
        pipeline report is ready for download
    end note
    deactivate Backend
end

loop until (response code is 201 and body.allMetricsReady==true) or (response code is 5xx) 
    Frontend -> Backend: Polling the report
    activate Backend
    alt report is not ready
        Backend --> Frontend: response 200
    else report is ready
        Backend --> Frontend: response 201 with report
    else fail to process 
        Backend --> Frontend: response 5xx
    end
    deactivate Backend
end 
@enduml
```

## C2 - Generate report - TO-BE
### Sequence Diagram


```plantuml
@startuml report
skin rose
title C2 - Heartbeat - Generate Report - Transition
participant Frontend
participant Backend
participant Jira
participant Buildkite
participant Github

Frontend -> Backend: generate metrics for board or dora or both of them
activate Backend
Backend --> Frontend: response 202 with callback
deactivate Backend


loop until (metricTypes list final element)
    Backend -> Backend: write metricType on one file
    activate Backend
    
    
    alt metricsType is Board
        Backend --> Backend: initialize boardMetricsCompleted index as false
        group async process board related metrics
            Backend -> Jira: get Jira raw data
            activate Backend
            activate Jira
            Jira --> Backend: Jira raw 
            deactivate Jira
            Backend -> Backend: calculate metrics for velocity, cycle time and classification
            Backend -> Backend: generate board report csv
            deactivate Backend
            note left
                update response.boardMetricsCompleted as true
                board metrics are ready for display
                board csv is ready for download
            end note
        end
        
        
    else metricsType is Dora
        Backend --> Backend: initialize doraMetricsCompleted as false
        group async process pipeline and sourcecontrol related metrics
            Backend -> Buildkite: get Buildkite raw data
            activate Backend
            activate Buildkite
            Buildkite --> Backend: Buildkite raw data
            deactivate Buildkite
            Backend -> Backend: calculate metrics for deployment frequency, \nchange failure rate and mean time to recovery
            note left
                pipeline metrics are ready for display
            end note
            opt if lead time for change required
                Backend -> Github: get Github raw data
                activate  Github
                Github --> Backend: Github raw data
                deactivate Github
                Backend -> Backend: calculate metrics for lead time for change
                note left
                    LTFC is ready for display
                end note
            end
            Backend -> Backend: generate pipeline report csv with github data if required
            note left
                update response.doraMetricsCompleted as true
                pipeline report is ready for download
            end note
            deactivate Backend
        end
    end
     deactivate Backend
end 


group async check if metricCsv can be generated 
 loop until (allMetricsCompleted==true) 
    Backend -> Backend: calculate the size of metricTypes list 
    alt the size of metricTypes list equal to one and metricTypes list contains board element
           Backend --> Backend: allMetricsCompleted index is decided by the value of boardMetricsCompleted index
       else the size of metricTypes list equal to one and metricTypes list contains dora element
           Backend --> Backend: allMetricsCompleted index is decided by the value of doraMetricsCompleted index
       else the size of metricTypes list equal to two and metricTypes list contains both board element and dora element
           Backend --> Backend: allMetricsCompleted index is decided by the combination of value for doraMetricsCompleted index and boardMetricsCompleted index
       end
       alt allMetricsCompleted is true
               Backend --> Backend: Metric csv generated, metric report is ready for download
           else allMetricsCompleted is false
            Backend --> Backend: Metric csv can not be generated, metric report is not ready for download
           end
               deactivate Backend
           end 
       deactivate Backend
   end 


loop until (response code is 201 and body.allMetricsCompleted==true) or (response code is 5xx) 
    Frontend -> Backend: Polling the report
    activate Backend
    alt report is not ready
        Backend --> Frontend: response 200
    else report is ready
        Backend --> Frontend: response 201 with report
    else fail to process 
        Backend --> Frontend: response 5xx
    end
    deactivate Backend
end 
@enduml
```

### API Design
the request body of generate report api is the same as as-is, but will add one parameter in the request body.
```
URI: POST /reports
Request payload:
{
   ...
   "metricsType": [
        "string"
      ]
}
```

