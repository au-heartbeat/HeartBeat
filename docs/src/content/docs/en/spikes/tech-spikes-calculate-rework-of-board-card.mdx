---
title: Spike the logic of calculating card rework
description: Spike the logic of calculating card rework
---

#

## Background

According to the needs of the business, users believe that analyzing the overall situation of the flow state of the card can be a good way to find the problems of the team and optimize the team.

## Expect

 1. View the rework times of all cards in the current iteration. 
 2. Export the rework times of each card.

## Solutions

### 1. Modifying the original API

#### 1.1 Modifying to generate report API design
On the design of the original report generating API, a new rework setting is added to the request body.
- AS-IS
```json
path: /reports/{metricType}
method: POST
request body: {
  ...
  "reworkTimesSetting" : {
      "reworkState": String
      "excludedStates": List<String>
  }
}
```

#### 1.2 Modifying to query generation metric API design
On the design of the original query generation metric API,  add rework metrics data to the response body.
- AS-IS
```json
path: /reports/{reportId}
method: GET
response: {
  ...
  "rework" : {
      "totalReworkTimes": Integer
      "reworkState": String
      "fromInDev": Integer
      "fromBlock": Integer
      "fromWaitingForTesting": Integer
      "fromTesting": Integer
      "fromReview": Integer
      "fromDone": Integer
      "totalReworkCards": Integer
      "reworkCardsRatio": Double

  }
}
```
### 3. Modifying the logic of generating a board csv
When generating the board csv file, we need to export the rework information of each card, so we need to add a series of table header information, and assemble and filter according to the config provided by reworkSetting. The following is the full table header information about rework:

- rework times to `status`
- from in dev to `status`
- from block to `status`
- from waiting for testing to `status`
- from testing to `status`
- from review to `status`
- from done to `status`

`status` is the  rework in our previous setting, and the exported table header is spliced according to it.

According to business needs, we will only have some headers, for example, we need to calculate `rework to review`, exported headers will only have `rework times to review` and `from done to review`.Because the meaning of rework is to calculate from the subsequent process to the previous process

*Implementation method*

In 2, we have obtained `reworkTimeInfos`, and then can use this data to write into a csv file.

tasking:
- In `KanbanCsvService.generateCSVForBoard()` method, we need to use reworkTimeInfos to build table header. Reference CycleTimeInfo to build the header.
- In `CSVFileGenerator.getFixedFieldsData()` method, we need to build the row for rework. Reference `CSVFileGenerator.getOriginCycleTimePerRow()`.
