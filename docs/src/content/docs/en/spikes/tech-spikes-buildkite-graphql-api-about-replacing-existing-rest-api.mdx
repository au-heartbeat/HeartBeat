---
title: Buildkite GraphQL API about replacing existing REST API
description: Buildkite GraphQL API about replacing existing REST API
---

## Background

Currently, our Buildkite API are all REST API, and the REST API has the problem of over-fetching or multiple requests.

## Expect

We want to use the GraphQL API to retrieve the key information we need. With the data obtained this way, we can calculate related metrics.

## Solutions

### Buildkite GraphQL Overview

The quickest way to get started with the GraphQL API is to generate an [API Access Token](https://buildkite.com/user/api-access-tokens) with GraphQL scope, and then use the [GraphQL explorer](https://graphql.buildkite.com/explorer) with its built-in documentation.
For the list of existing disparities between the GraphQL API and the REST API, see [API differences](https://buildkite.com/docs/apis/api-differences).

#### Endpoint

The GraphQL API endpoint is `https://graphql.buildkite.com/v1`. All requests must be HTTP POST requests with `application/json` encoded bodies.

#### Authentication

GraphQL requests must be authenticated using an [API access token](https://buildkite.com/user/api-access-tokens) with the GraphQL scope enabled. Pass the token in your GraphQL request using the `Authorization` HTTP header with a value `Bearer <token>`.

### Using Buildkite GraphQL to replace REST

#### Get the buildkite token info

1.We need to verify the permission scopes.
*Existing REST API*
- GET v2/access-token
Key info we need as follows:
```
{
"scopes": [
      "string"
    ]
}
```

*Using GraphQL API*
GraphQL Scheme:
```
query getTokenScope {
  organization(slug: ID!) {
    apiAccessTokens(first: int) {
      nodes {
        scopes
      }
    }
  }
}
```
slug: ID ---- "organization-slug"
first: Int ---- 10

2.We need to get buildkite organisation info. 
*Existing REST API*
- GET v2/organizations
Key info we need as follows:
```
{
"name": "string",
"slug": "string"
}
```
Actually this REST doesn't fetch unused info, and we didn't find a scheme we need.

3.We need to get our pipeline info.
*Existing REST API*
- GET v2/organizations/{organizationId}/pipelines?page={page}&per_page={perPage}
Key info we need as follows:
```
{
"id": "string",
"name": "string",
"orgId": "string",
"orgName": "string",
"repository": "string",
"steps": [
    "string"
  ]
}
```

*Using GraphQL API*
GraphQL Scheme:
```
query getPipelineInfo {
  organization(slug: ID!) {
    slug
    name
    pipelines(first: Int) {
      edges {
        node {
          slug
          name
          repository {
            url
          }
          steps {
            yaml
          }
        }
      }
    }
  }
}
```
Query variables:
slug: ID ---- "organization-slug"
first: Int ---- 10


4.We need to get our pipeline steps info.
*Existing REST API*
- GET v2/organizations/{organizationId}/pipelines/{pipelineId}/builds
Key info we need as follows:
```
{
	"state": "string",
	"commit": "string",
  "creator": {
      "name": "string",
      "email": "string"
    }
	"pipelineCreateTime": "string",
	"branch": "string",
	"repository": "string",
	"number": 4004,
	"steps": [
		"jobs": {
			"name": "string",
			"state": "string",
			"startedAt": "string",
			"finishedAt": "string"
		}
	]
}
```

*Using GraphQL API*
We find almost all steps info we need can get from this scheme. But we can't get the exact name of jobs in a build. So we still need to do more research if we want to get the key info about pipeline steps info.
GraphQL Scheme:
```
query getPipelineStepsInfo {
  pipeline(slug: ID!) {
    builds(first: Int, ...) {
      pageInfo {
        endCursor
        hasNextPage
      }
      edges {
        node {
          state
          branch
          commit
          number
          createdAt
          createdBy {
            ... on User {
              name
              email
            }
            ... on UnregisteredUser {
              name
              email
            }
          }
          startedAt
          finishedAt
          url
          uuid
          jobs(passed: true, last: 1) {
            edges {
              node {
                ... on JobTypeCommand {
                  command
                  createdAt
                }
              }
            }
          }
        }
      }
    }
  }
}
```
Query variables:
slug: ID ---- "organization-slug/pipeline-slug"
The slug of the pipeline, prefixed with its organization. i.e. acme-inc/my-pipeline

Builds variable: can refer [pipeline-> builds](https://buildkite.com/docs/apis/graphql/schemas/object/pipeline)
after: String
Returns the elements in the list that come after the specified cursor.

before: String
Returns the elements in the list that come before the specified cursor.

branch: [String!]
Use %default to search by the Pipelines default branch

commit: [String!]

createdAtFrom: DateTime

createdAtTo: DateTime

first: Int
Returns the first n elements from the list.

last: Int
Returns the last n elements from the list.

state: [BuildStates!]
